---
title: "Implementando ICs"
author: "Nazareno"
output:
  html_document:
    theme: readable
    df_print: paged
    toc: yes
  html_notebook:
    fig_width: 7
    theme: readable
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
theme_set(theme_bw())
```

## Os dados

```{r}
set.seed(12345)

lastfm = read_csv(here::here("data/experimento-lastfm.csv"), 
                  col_types = cols(.default = col_double(), 
                                   user = col_character()))

lastfm = lastfm %>% 
  sample_n(300) %>% 
  select(news, old, mediana_pop)

glimpse(lastfm)
```

## Proporção de artistas novos e popularidade

Utilizaremos ICs para estimar duas métricas sobre os usuários do LastFM em geral durante um período de 6 meses. Em ambos os casos faremos isso a partir de uma amostra de 300 usuários. As duas métricas são: 

1. Qual a proporção de novos artistas escutados pelos usuários

### Bootstrap implementado manualmente

```{r}
n_repeticoes = 2000

proporcao_do_pai = lastfm %>% mutate(prop = news/(news+old)) %>% pull(prop) %>% mean()

props_bootstraps = c()

for(i in  1:n_repeticoes) {
  prop_bootstrap_atual = lastfm %>% sample_n(300, replace = TRUE) %>% mutate(prop = news/(news+old)) %>% pull(prop) %>% mean()
  props_bootstraps = c(props_bootstraps, prop_bootstrap_atual)
}

df_bootstraps = data.frame("bnum" = c(1:2000), "props" = props_bootstraps)
  
df_bootstraps %>% ggplot(aes(x=props) ) + geom_histogram(fill="navy", alpha=.4, col="black") + geom_vline(aes(xintercept=proporcao_do_pai), color="red", size=2, alpha=.4)

```
### Bootsrap implementado com a biblioteca

```{r}
library(boot)

theta_p <- function(d, i) {
    d %>%
    slice(i)  %>% 
    mutate(prop = news/(news+old)) %>% 
    pull(prop) %>% 
    mean()
}

theta_c = theta_p(lastfm, 1:NROW(lastfm))

lastfm %>% boot(statistic = theta_p, R = 2000) %>%
  tidy(conf.level = 0.95, conf.int = TRUE)


```



2. Para os usuários que gostam de música muito pop (mediana_pop > 5), qual a correlação entre a popularidade mediana dos artistas escutado e a proporção dos artistas escutados que eram novos. 



```{r}


n_repeticoes = 2000


correlacoes = c()

for(i in  1:n_repeticoes) {
  bootstrap_atual = lastfm %>% sample_n(300, replace = TRUE) %>% filter(mediana_pop >5) %>% mutate(prop = news/(news+old))
  theta_cor = bootstrap_atual %>% cor(mediana_pop, prop)
}



```

